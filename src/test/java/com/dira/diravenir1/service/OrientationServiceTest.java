package com.dira.diravenir1.service;

import com.dira.diravenir1.dto.*;
import com.dira.diravenir1.impl.OrientationServiceImpl;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import static org.junit.jupiter.api.Assertions.*;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@SpringBootTest
public class OrientationServiceTest {

    private OrientationService orientationService;

    @BeforeEach
    void setUp() {
        orientationService = new OrientationServiceImpl();
    }

    @Test
    void testCalculateOrientationWithExampleAnswers() {
        // Cr√©er une requ√™te de test avec les r√©ponses d'exemple du document
        OrientationRequestDTO testRequest = new OrientationRequestDTO();
        testRequest.setQuestion1("E"); // Exprimer ma cr√©ativit√©
        testRequest.setQuestion2(Arrays.asList("C")); // D√©veloppement personnel, Causes sociales
        testRequest.setQuestion3("D"); // Livres de d√©veloppement personnel...
        testRequest.setQuestion4("C"); // Imaginer des solutions originales
        testRequest.setQuestion5(Arrays.asList("G", "H", "B")); // Convaincre (1), Conseiller ami (2), Organiser √©v√©nement (3)
        testRequest.setQuestion6("A"); // Lire et prendre des notes d√©taill√©es
        testRequest.setQuestion7("A"); // Am√©liorer la vie des individus directement
        testRequest.setQuestion8("D"); // L'ext√©rieur, la nature, un chantier
        testRequest.setQuestion9(Map.of("A", 1, "B", 5, "C", 5, "D", 5)); // Curseurs
        testRequest.setQuestion10("B"); // Mettre en place rapidement une solution concr√®te
        testRequest.setQuestion11("A"); // Seul(e) sur un projet, en totale autonomie
        testRequest.setQuestion12("B"); // Raconter une histoire pour capter l'attention
        testRequest.setQuestion13("B"); // Votre intuition et vos sentiments
        testRequest.setQuestion14(Arrays.asList("D")); // Arts et Design

        // Ex√©cuter le calcul
        OrientationResponseDTO response = orientationService.calculateOrientation(testRequest);

        // V√©rifications de base
        assertNotNull(response, "La r√©ponse ne doit pas √™tre null");
        assertNotNull(response.getUserProfile(), "Le profil utilisateur ne doit pas √™tre null");
        assertNotNull(response.getTop3Recommendations(), "Les top 3 recommandations ne doivent pas √™tre null");
        assertNotNull(response.getAllRecommendations(), "Toutes les recommandations ne doivent pas √™tre null");
        assertNotNull(response.getSummary(), "Le r√©sum√© ne doit pas √™tre null");

        // V√©rifier que nous avons des recommandations
        assertTrue(response.getTop3Recommendations().size() > 0, "Il doit y avoir au moins une recommandation");
        assertTrue(response.getAllRecommendations().size() > 0, "Il doit y avoir des recommandations");

        // V√©rifier que le top 1 est Architecture (selon l'exemple du document)
        MajorRecommendationDTO topRecommendation = response.getTop3Recommendations().get(0);
        assertNotNull(topRecommendation, "La premi√®re recommandation ne doit pas √™tre null");
        assertNotNull(topRecommendation.getName(), "Le nom de la majeure ne doit pas √™tre null");
        assertTrue(topRecommendation.getMatchingScore() > 0, "Le score de matching doit √™tre positif");
        assertTrue(topRecommendation.getMatchingScore() <= 100, "Le score de matching ne doit pas d√©passer 100");

        // V√©rifier que le profil utilisateur est normalis√© (0-100)
        UserProfileDTO userProfile = response.getUserProfile();
        assertProfileNormalized(userProfile);

        System.out.println("‚úÖ Test r√©ussi !");
        System.out.println("üèÜ Top recommandation : " + topRecommendation.getName() + " (" + topRecommendation.getMatchingScore() + "%)");
        System.out.println("üìä Nombre total de recommandations : " + response.getAllRecommendations().size());
    }

    @Test
    void testProfileNormalization() {
        // Cr√©er un profil avec des scores bruts
        UserProfileDTO rawProfile = new UserProfileDTO();
        rawProfile.setInteretArtistiqueCreatif(20); // Score brut sur 21
        rawProfile.setInteretScientifiqueTech(15); // Score brut sur 21
        rawProfile.setInteretSocialHumain(18); // Score brut sur 20

        // V√©rifier que les scores sont dans la plage 0-100
        assertTrue(rawProfile.getInteretArtistiqueCreatif() >= 0, "Le score doit √™tre positif");
        assertTrue(rawProfile.getInteretArtistiqueCreatif() <= 100, "Le score normalis√© ne doit pas d√©passer 100");
    }

    @Test
    void testMatchingAlgorithm() {
        // Cr√©er deux profils pour tester l'algorithme de matching
        UserProfileDTO userProfile = new UserProfileDTO();
        userProfile.setInteretArtistiqueCreatif(95);
        userProfile.setInteretScientifiqueTech(60);
        userProfile.setInteretSocialHumain(70);

        UserProfileDTO majorProfile = new UserProfileDTO();
        majorProfile.setInteretArtistiqueCreatif(90);
        majorProfile.setInteretScientifiqueTech(60);
        majorProfile.setInteretSocialHumain(70);

        // Le matching devrait √™tre √©lev√© car les profils sont similaires
        // Note: Ce test n√©cessiterait l'acc√®s aux m√©thodes priv√©es via reflection
        // ou la cr√©ation de m√©thodes publiques de test
        assertTrue(true, "Test de base r√©ussi");
    }

    @Test
    void testAllMajorsRetrieval() {
        // Tester la r√©cup√©ration de toutes les majeures
        List<String> allMajors = orientationService.getAllMajors();
        
        assertNotNull(allMajors, "La liste des majeures ne doit pas √™tre null");
        assertTrue(allMajors.size() > 0, "Il doit y avoir des majeures disponibles");
        
        // V√©rifier que chaque majeure a un nom
        for (String major : allMajors) {
            assertNotNull(major, "Chaque majeure doit avoir un nom");
            assertFalse(major.trim().isEmpty(), "Le nom de la majeure ne doit pas √™tre vide");
        }

        System.out.println("üìö Nombre de majeures disponibles : " + allMajors.size());
    }

    @Test
    void testTestWithExampleAnswers() {
        // Tester la m√©thode de test avec des r√©ponses d'exemple
        OrientationRequestDTO exampleRequest = createExampleRequest();
        OrientationResponseDTO testResponse = orientationService.calculateOrientation(exampleRequest);
        
        assertNotNull(testResponse, "La r√©ponse du test ne doit pas √™tre null");
        assertNotNull(testResponse.getTop3Recommendations(), "Les recommandations ne doivent pas √™tre null");
        assertTrue(testResponse.getTop3Recommendations().size() > 0, "Il doit y avoir des recommandations");
        
        System.out.println("üß™ Test avec exemples r√©ussi !");
        System.out.println("üèÜ Premi√®re recommandation : " + testResponse.getTop3Recommendations().get(0).getName());
    }
    
    /**
     * Cr√©e une requ√™te d'exemple pour les tests
     */
    private OrientationRequestDTO createExampleRequest() {
        OrientationRequestDTO request = new OrientationRequestDTO();
        
        // Question 1: Int√©r√™t scientifique/technique
        request.setQuestion1("Tr√®s int√©ress√©");
        
        // Question 2: Int√©r√™ts multiples (s√©lection multiple)
        request.setQuestion2(Arrays.asList("Sciences", "Technologie", "Math√©matiques"));
        
        // Question 3: Int√©r√™t artistique/cr√©atif
        request.setQuestion3("Int√©ress√©");
        
        // Question 4: Int√©r√™t social/humain
        request.setQuestion4("Tr√®s int√©ress√©");
        
        // Question 5: Int√©r√™ts sp√©cifiques (drag & drop)
        request.setQuestion5(Arrays.asList("Business", "Gestion", "Leadership"));
        
        // Question 6: Int√©r√™t logique/analytique
        request.setQuestion6("Tr√®s int√©ress√©");
        
        // Question 7: Comp√©tence r√©solution de probl√®mes
        request.setQuestion7("Tr√®s comp√©tent");
        
        // Question 8: Comp√©tence communication
        request.setQuestion8("Comp√©tent");
        
        // Question 9: Pr√©f√©rences de travail (sliders)
        Map<String, Integer> workPrefs = new HashMap<>();
        workPrefs.put("√âquipe", 80);
        workPrefs.put("Autonome", 60);
        workPrefs.put("Pratique", 70);
        workPrefs.put("Th√©orie", 50);
        request.setQuestion9(workPrefs);
        
        // Question 10: Valeur impact soci√©tal
        request.setQuestion10("Tr√®s important");
        
        // Question 11: Valeur innovation/d√©fi
        request.setQuestion11("Important");
        
        // Question 12: Valeur stabilit√©/s√©curit√©
        request.setQuestion12("Mod√©r√©ment important");
        
        // Question 13: Valeur autonomie
        request.setQuestion13("Important");
        
        // Question 14: Comp√©tences organisationnelles
        request.setQuestion14(Arrays.asList("Organisation", "Planification", "Gestion de projet"));
        
        return request;
    }

    /**
     * V√©rifie que tous les scores du profil sont normalis√©s (0-100)
     */
    private void assertProfileNormalized(UserProfileDTO profile) {
        // V√©rifier les piliers d'int√©r√™ts
        assertScoreInRange(profile.getInteretScientifiqueTech(), "InteretScientifiqueTech");
        assertScoreInRange(profile.getInteretArtistiqueCreatif(), "InteretArtistiqueCreatif");
        assertScoreInRange(profile.getInteretSocialHumain(), "InteretSocialHumain");
        assertScoreInRange(profile.getInteretBusinessGestion(), "InteretBusinessGestion");
        assertScoreInRange(profile.getInteretLogiqueAnalytique(), "InteretLogiqueAnalytique");

        // V√©rifier les piliers de comp√©tences
        assertScoreInRange(profile.getCompetenceResolutionProblemes(), "CompetenceResolutionProblemes");
        assertScoreInRange(profile.getCompetenceCommunication(), "CompetenceCommunication");
        assertScoreInRange(profile.getCompetenceOrganisation(), "CompetenceOrganisation");
        assertScoreInRange(profile.getCompetenceManuelTechnique(), "CompetenceManuelTechnique");

        // V√©rifier les piliers de valeurs
        assertScoreInRange(profile.getValeurImpactSocietal(), "ValeurImpactSocietal");
        assertScoreInRange(profile.getValeurInnovationChallenge(), "ValeurInnovationChallenge");
        assertScoreInRange(profile.getValeurStabiliteSecurite(), "ValeurStabiliteSecurite");
        assertScoreInRange(profile.getValeurAutonomie(), "ValeurAutonomie");

        // V√©rifier les piliers de pr√©f√©rences
        assertScoreInRange(profile.getPrefTravailEquipeCollab(), "PrefTravailEquipeCollab");
        assertScoreInRange(profile.getPrefTravailAutonome(), "PrefTravailAutonome");
        assertScoreInRange(profile.getPrefPratiqueTerrain(), "PrefPratiqueTerrain");
        assertScoreInRange(profile.getPrefTheorieRecherche(), "PrefTheorieRecherche");
    }

    /**
     * V√©rifie qu'un score est dans la plage 0-100
     */
    private void assertScoreInRange(int score, String pillarName) {
        assertTrue(score >= 0, pillarName + " doit √™tre >= 0, mais √©tait " + score);
        assertTrue(score <= 100, pillarName + " doit √™tre <= 100, mais √©tait " + score);
    }
}
