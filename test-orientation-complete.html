<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Orientation Compl√®te - Diravenir</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .test-button:hover {
            background: #45a049;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .major-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Orientation Compl√®te - Diravenir</h1>
        <p>Ce test simule un parcours d'orientation complet pour v√©rifier que les r√©sultats sont dynamiques.</p>
        
        <button class="test-button" onclick="runCompleteTest()">
            üöÄ Lancer le Test Complet
        </button>
        
        <div id="results"></div>
    </div>

    <script>
        // R√©ponses de test r√©alistes
        const testAnswers = {
            1: 'A', // Cr√©er quelque chose de nouveau
            2: 'C', // D√©veloppement personnel, Causes sociales
            3: 'B', // Cr√©atif
            4: 'A', // R√©soudre des probl√®mes complexes
            5: 'C', // Travail en √©quipe
            6: 'B', // Cr√©ativit√© et innovation
            7: 'A', // Projets pratiques
            8: 'C', // Impact social
            9: JSON.stringify({
                security: 70,
                innovation: 80,
                autonomy: 60,
                salary: 50
            }),
            10: 'B', // Apprentissage continu
            11: 'A', // Travail autonome
            12: 'C', // Impact positif
            13: 'B', // Cr√©ativit√©
            14: 'A'  // Sciences et technologie
        };

        async function runCompleteTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Test en cours...</p>';
            
            try {
                // 1. Simuler les r√©ponses dans localStorage
                console.log('üìù Simulation des r√©ponses...');
                Object.keys(testAnswers).forEach(questionId => {
                    localStorage.setItem(`orientation_answer_${questionId}`, testAnswers[questionId]);
                });
                
                // 2. Pr√©parer les donn√©es pour l'API
                const orientationRequest = {
                    q1: testAnswers[1],
                    q2: testAnswers[2],
                    q3: testAnswers[3],
                    q4: testAnswers[4],
                    q5: testAnswers[5],
                    q6: testAnswers[6],
                    q7: testAnswers[7],
                    q8: testAnswers[8],
                    q9: testAnswers[9],
                    q10: testAnswers[10],
                    q11: testAnswers[11],
                    q12: testAnswers[12],
                    q13: testAnswers[13],
                    q14: testAnswers[14],
                    studentInfo: {
                        fullName: 'Test User',
                        phone: '+33123456789',
                        email: 'test@example.com'
                    }
                };
                
                console.log('üì§ Envoi des donn√©es √† l\'API backend...');
                
                // 3. Appeler l'API backend
                const baseURL = 'http://localhost:8084';
                const response = await fetch(`${baseURL}/api/orientation/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orientationRequest)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ R√©sultats re√ßus:', result);
                    
                    // 4. Afficher les r√©sultats
                    displayResults(result);
                    
                    // 5. Simuler le stockage en localStorage comme dans l'app
                    const frontendResults = {
                        topRecommendations: result.recommendations.slice(0, 3).map(rec => ({
                            majorCode: rec.majorCode,
                            majorName: rec.majorName,
                            matchingScore: rec.matchingScore,
                            matchingPercentage: `${Math.round(rec.matchingScore)}%`,
                            description: rec.reasoning || '',
                            whyThisMajor: rec.reasoning || '',
                            pillarComparison: {}
                        })),
                        userProfile: result.userProfile,
                        calculationMethod: 'BACKEND'
                    };
                    
                    localStorage.setItem('orientationResults', JSON.stringify(frontendResults));
                    localStorage.setItem('studentInfo', JSON.stringify(orientationRequest.studentInfo));
                    
                    console.log('‚úÖ R√©sultats stock√©s en localStorage:', frontendResults);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(`Erreur API: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur lors du test</h3>
                        <p>${error.message}</p>
                        <p><strong>V√©rifiez que le backend est d√©marr√© sur le port 8084.</strong></p>
                    </div>
                `;
            }
        }
        
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="results">
                    <h3>üéØ R√©sultats du Test d'Orientation</h3>
                    <p><strong>‚úÖ Test r√©ussi !</strong> Les r√©sultats sont maintenant dynamiques.</p>
                    
                    <h4>üë§ Profil Utilisateur (Top 5 Piliers)</h4>
                    <div style="margin: 10px 0;">
            `;
            
            // Afficher les top 5 piliers
            const topPillars = Object.entries(result.userProfile)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
                
            topPillars.forEach(([pillar, score]) => {
                html += `<div style="margin: 5px 0;"><strong>${pillar}:</strong> ${Math.round(score)}%</div>`;
            });
            
            html += `
                    </div>
                    
                    <h4>üéì Top 3 Majeures Recommand√©es</h4>
            `;
            
            // Afficher les recommandations
            result.recommendations.slice(0, 3).forEach((rec, index) => {
                html += `
                    <div class="major-card">
                        <h5>#${index + 1} ${rec.majorName}</h5>
                        <div class="score">${Math.round(rec.matchingScore)}%</div>
                        <p><strong>Code:</strong> ${rec.majorCode}</p>
                        <p><strong>Cat√©gorie:</strong> ${rec.category}</p>
                        <p><strong>Raison:</strong> ${rec.reasoning}</p>
                    </div>
                `;
            });
            
            html += `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                        <h4>üéâ Probl√®me R√©solu !</h4>
                        <p>Les r√©sultats affichent maintenant des pourcentages calcul√©s dynamiquement :</p>
                        <ul>
                            <li><strong>${result.recommendations[0].majorName}:</strong> ${Math.round(result.recommendations[0].matchingScore)}% (au lieu de 0%)</li>
                            <li><strong>${result.recommendations[1].majorName}:</strong> ${Math.round(result.recommendations[1].matchingScore)}% (au lieu de 0%)</li>
                            <li><strong>${result.recommendations[2].majorName}:</strong> ${Math.round(result.recommendations[2].matchingScore)}% (au lieu de 0%)</li>
                        </ul>
                        <p><strong>‚úÖ Le syst√®me d'orientation fonctionne maintenant correctement !</strong></p>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
